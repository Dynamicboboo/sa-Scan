<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linea Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; /* 所有文字内容居中 */
        }

        th {
            background-color: #f2f2f2;
        }

        #dataTable {
            margin-top: 20px;
            display: none;
        }

        #addAddressButton {
            margin-top: 20px;
        }

        #addressInputDialog {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border: 1px solid #ccc;
            background: #fff;
            z-index: 1000;
            width: 380px; /* 增大弹出窗口 */
        }

        #fingerprintDialog {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border: 1px solid #ccc;
            background: #fff;
            z-index: 1000;
            width: 200px; /* 增大弹出窗口 */
        }

        #addressInputDialog textarea {
            width: 100%;
            height: 200px; /* 增大输入框 */
        }

        #fingerprintDialog textarea {
            width: 100%;
            height: 20px; /* 增大输入框 */
        }

        .dialog-buttons {
            margin-top: 10px;
            text-align: center; /* 按钮居中 */
        }

        .dialog-buttons button {
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }

        .red-text {
            color: red;
        }

    </style>
    <script type="module">
        import getLineaData, { loadDataFromCache, saveDataToCache, getETHMainnetTX } from './main.js';

        const displayData = (data) => {
            if (!Array.isArray(data)) {
                console.error('Data is not an array', data);
                return;
            }

            const table = document.getElementById('dataTable');
            const tbody = document.getElementById('dataBody');

            // Clear existing rows
            tbody.innerHTML = '';

            const now = new Date();

            data.forEach((entry) => {
                const lastTxDate = new Date(entry.activity.lastTx);
                const queryDate = new Date(entry.queryTime);
                const lastTxClass = (now - lastTxDate) / (1000 * 60 * 60 * 24) >= 7 ? 'red-text' : '';
                const queryTimeClass = (now - queryDate) / (1000 * 60 * 60 * 24) >= 1 ? 'red-text' : '';

                const txClass = entry.activity.tx < 10 ? 'red-text' : '';
                const ethMainnetTxClass = entry.ethMainnetTX < 5 ? 'red-text' : '';
                const contractActivityClass = entry.activity.contractActivity < 10 ? 'red-text' : '';

                const lastTx = (now - lastTxDate) / (1000 * 60 * 60 * 24) >= 1
                    ? `${Math.floor((now - lastTxDate) / (1000 * 60 * 60 * 24))}天前`
                    : (now - lastTxDate) / (1000 * 60 * 60) >= 1
                    ? `${Math.floor((now - lastTxDate) / (1000 * 60 * 60))}小时前`
                    : `${Math.floor((now - lastTxDate) / (1000 * 60))}分钟前`;

                const row = document.createElement('tr');
                row.setAttribute('data-address', entry.address);

                row.innerHTML = `
                    <td><button onclick="editFingerprint('${entry.address}')">${entry.fingerprint || '编辑'}</button></td>
                    <td>${entry.address.slice(0, 4)}...${entry.address.slice(-4)}</td>
                    <td class="${txClass}">${entry.activity.tx}</td>
                    <td class="${ethMainnetTxClass}">${entry.ethMainnetTX || 0}</td>
                    <td class="${lastTxClass}">${lastTx}</td>
                    <td class="${contractActivityClass}">${entry.activity.contractActivity}</td>
                    <td>${entry.activity.fee}</td>
                    <td class="${queryTimeClass}">${entry.queryTime}</td>
                    <td><button onclick="reQuery('${entry.address}')">重新查询</button></td>
                    <td><button onclick="deleteEntry('${entry.address}')">删除</button></td>
                `;

                tbody.appendChild(row);
            });

            table.style.display = 'table';
            saveDataToCache(data);
        };

        const fetchData = async (addresses) => {
            let data = loadDataFromCache() || [];
            for (const address of addresses) {
                const existingEntry = data.find(entry => entry.address === address);
                if (!existingEntry) {
                    const result = await getLineaData(address);
                    if (result.result === "success") {
                        const ethMainnetTX = await getETHMainnetTX(address);
                        result.ethMainnetTX = ethMainnetTX;
                        result.queryTime = new Date().toLocaleString();
                        data.push(result);
                    } else {
                        alert("Error: " + result.reason);
                    }
                }
            }
            displayData(data);
        };

        const showAddressInputDialog = () => {
            const dialog = document.getElementById('addressInputDialog');
            document.getElementById('addressTextarea').value = ''; // 清空弹窗内容
            dialog.style.display = 'block';
        };

        const hideAddressInputDialog = () => {
            const dialog = document.getElementById('addressInputDialog');
            dialog.style.display = 'none';
        };

        const addAddresses = () => {
            const addressesInput = document.getElementById('addressTextarea').value;
            hideAddressInputDialog();
            if (addressesInput) {
                const addresses = addressesInput.split('\n').map(addr => addr.trim()).filter(addr => addr);
                if (addresses.length) {
                    fetchData(addresses);
                }
            }
        };

        const editFingerprint = (address) => {
            const dialog = document.getElementById('fingerprintDialog');
            const textarea = document.getElementById('fingerprintTextarea');
            textarea.setAttribute('data-address', address);
            textarea.value = ''; // 清空弹窗内容
            dialog.style.display = 'block';
        };

        const saveFingerprint = () => {
            const textarea = document.getElementById('fingerprintTextarea');
            const address = textarea.getAttribute('data-address');
            const newFingerprint = textarea.value;
            const dialog = document.getElementById('fingerprintDialog');
            dialog.style.display = 'none';

            if (newFingerprint !== null) {
                let data = loadDataFromCache() || [];
                const entry = data.find(entry => entry.address === address);
                if (entry) {
                    entry.fingerprint = newFingerprint;
                    saveDataToCache(data);
                    displayData(data); // 更新页面显示
                }
            }
        };

        window.reQuery = async (address) => {
            let data = loadDataFromCache() || [];
            const index = data.findIndex(entry => entry.address === address);
            if (index !== -1) {
                const result = await getLineaData(address);
                if (result.result === "success") {
                    const ethMainnetTX = await getETHMainnetTX(address);
                    result.ethMainnetTX = ethMainnetTX;
                    result.queryTime = new Date().toLocaleString();
                    result.fingerprint = data[index].fingerprint; // preserve fingerprint
                    data[index] = result;
                    displayData(data);
                } else {
                    alert("Error: " + result.reason);
                }
            }
        };

        window.deleteEntry = (address) => {
            let data = loadDataFromCache() || [];
            data = data.filter(entry => entry.address !== address);
            displayData(data);
        };

        window.editFingerprint = editFingerprint; // 确保函数在全局范围内可用
        window.saveFingerprint = saveFingerprint; // 确保函数在全局范围内可用

        document.addEventListener('DOMContentLoaded', () => {
            const cachedData = loadDataFromCache();
            if (cachedData) {
                displayData(cachedData);
            }

            document.getElementById('addAddressButton').addEventListener('click', showAddressInputDialog);
            document.getElementById('saveAddressButton').addEventListener('click', addAddresses);
            document.getElementById('cancelAddressButton').addEventListener('click', hideAddressInputDialog);
            document.getElementById('saveFingerprintButton').addEventListener('click', saveFingerprint);
            document.getElementById('cancelFingerprintButton').addEventListener('click', () => {
                document.getElementById('fingerprintDialog').style.display = 'none';
            });
        });
    </script>
</head>
<body>
    <button id="addAddressButton">添加地址</button>

    <div id="addressInputDialog">
        <textarea id="addressTextarea" placeholder="请输入地址，每行一个"></textarea>
        <div class="dialog-buttons">
            <button id="saveAddressButton">确定</button>
            <button id="cancelAddressButton">取消</button>
        </div>
    </div>

    <div id="fingerprintDialog">
        <textarea id="fingerprintTextarea" placeholder="请输入指纹序号"></textarea>
        <div class="dialog-buttons">
            <button id="saveFingerprintButton">保存</button>
            <button id="cancelFingerprintButton">取消</button>
        </div>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>指纹序号</th>
                <th>地址</th>
                <th>TX数</th>
                <th>主网TX</th>
                <th>上次交易时间</th>
                <th>合约数</th>
                <th>Gas费</th>
                <th>查询时间</th>
                <th>重新查询</th>
                <th>删除</th>
            </tr>
        </thead>
        <tbody id="dataBody"></tbody>
    </table>
</body>
</html>
